{% extends 'base.html' %}

{% block title %}Internal Linking Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>üîó Internal Linking Manager</h2>
    
    <!-- Settings Panel -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>‚öôÔ∏è Linking Preferences</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   name="auto_link_enabled" id="autoLinkEnabled"
                                   {% if profile.auto_link_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="autoLinkEnabled">
                                Enable automatic internal linking
                            </label>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Maximum internal links per post</label>
                            <input type="number" class="form-control" name="max_internal_links" 
                                   value="{{ profile.max_internal_links }}" min="1" max="20">
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   name="prefer_same_category" id="preferCategory"
                                   {% if profile.prefer_same_category %}checked{% endif %}>
                            <label class="form-check-label" for="preferCategory">
                                Prefer linking within same category
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   name="vary_anchor_text" id="varyAnchor"
                                   {% if profile.vary_anchor_text %}checked{% endif %}>
                            <label class="form-check-label" for="varyAnchor">
                                Vary anchor text (recommended for SEO)
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Save Preferences</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>üìä Most Linked Posts</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for post in popular_posts %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ post.title|truncatechars:40 }}</h6>
                                <small>{{ post.topic }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">
                                {{ post.link_to_this_count }} links
                            </span>
                        </div>
                        {% empty %}
                        <p class="text-muted">No linked posts yet</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Linking Rules -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>üìå Custom Linking Rules</h5>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                + Add Rule
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Keyword</th>
                            <th>Target Post</th>
                            <th>Priority</th>
                            <th>Max Usage</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rule in rules %}
                        <tr>
                            <td><strong>{{ rule.keyword }}</strong></td>
                            <td>{{ rule.target_post.title|truncatechars:40 }}</td>
                            <td>{{ rule.priority }}</td>
                            <td>{{ rule.max_usage }}</td>
                            <td>
                                <span class="badge bg-{% if rule.is_active %}success{% else %}secondary{% endif %}">
                                    {% if rule.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary">Edit</button>
                                <button class="btn btn-sm btn-outline-danger">Delete</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                No custom linking rules yet. Rules will be auto-created as you publish posts.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Linking Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <div class="mb-3">
                        <label class="form-label">Keyword/Phrase</label>
                        <input type="text" class="form-control" name="keyword" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Post</label>
                        <select class="form-control" name="target_post" required>
                            <option value="">Select a post...</option>
                            {% for post in recent_posts %}
                            <option value="{{ post.id }}">{{ post.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority (1-10)</label>
                        <input type="number" class="form-control" name="priority" value="5" min="1" max="10">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">Save Rule</button>
            </div>
        </div>
    </div>
</div>
<!-- Add this script section at the bottom of internal_links.html -->
{% block extra_js %}
<script>
// CSRF Token setup for AJAX
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Show alert message
function showAlert(message, type = 'success') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.getElementById('alertContainer').insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (!alert.classList.contains('fade')) return;
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
}

// Save linking rule via AJAX
function saveRule() {
    const form = document.getElementById('addRuleForm');
    const formData = new FormData(form);
    
    const data = {
        keyword: formData.get('keyword'),
        target_post_id: formData.get('target_post'),
        priority: formData.get('priority') || 5
    };
    
    fetch("{% url 'publisher:ajax_create_rule' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Linking rule created successfully!', 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addRuleModal'));
            modal.hide();
            // Reload rules table
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Network error: ' + error, 'danger');
    });
}

// Toggle rule active/inactive
function toggleRule(ruleId, button) {
    fetch(`/internal-links/rule/${ruleId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update button appearance
            const badge = button.closest('tr').querySelector('.badge');
            if (data.is_active) {
                badge.classList.remove('bg-secondary');
                badge.classList.add('bg-success');
                badge.textContent = 'Active';
                button.textContent = 'Deactivate';
                button.classList.remove('btn-success');
                button.classList.add('btn-warning');
            } else {
                badge.classList.remove('bg-success');
                badge.classList.add('bg-secondary');
                badge.textContent = 'Inactive';
                button.textContent = 'Activate';
                button.classList.remove('btn-warning');
                button.classList.add('btn-success');
            }
            showAlert('Rule status updated!', 'success');
        }
    })
    .catch(error => {
        showAlert('Error toggling rule: ' + error, 'danger');
    });
}

// Delete rule with confirmation
function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this linking rule?')) {
        return;
    }
    
    fetch(`/internal-links/rule/${ruleId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => {
        if (response.ok) {
            showAlert('Rule deleted successfully!', 'success');
            // Remove row from table
            document.querySelector(`#rule-${ruleId}`).remove();
        } else {
            showAlert('Error deleting rule', 'danger');
        }
    })
    .catch(error => {
        showAlert('Network error: ' + error, 'danger');
    });
}

// Get link suggestions based on content
function getLinkSuggestions() {
    const topic = document.getElementById('suggestionTopic').value;
    const content = document.getElementById('suggestionContent').value;
    
    if (!topic) {
        showAlert('Please enter a topic', 'warning');
        return;
    }
    
    // Show loading spinner
    const suggestionsDiv = document.getElementById('suggestionsResults');
    suggestionsDiv.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
    
    fetch("{% url 'publisher:ajax_link_suggestions' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            topic: topic,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        let html = '<h6>Related Posts Found:</h6>';
        
        if (data.related_posts && data.related_posts.length > 0) {
            html += '<ul class="list-group">';
            data.related_posts.forEach(post => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${post.title}</strong><br>
                            <small class="text-muted">${post.topic}</small>
                        </div>
                        <button class="btn btn-sm btn-primary" 
                                onclick="createQuickRule('${post.title}', ${post.id})">
                            Create Rule
                        </button>
                    </li>
                `;
            });
            html += '</ul>';
            
            if (data.keywords_found && data.keywords_found.length > 0) {
                html += '<h6 class="mt-3">Keywords Found:</h6>';
                html += '<div class="mb-2">';
                data.keywords_found.forEach(keyword => {
                    html += `<span class="badge bg-info me-1">${keyword}</span>`;
                });
                html += '</div>';
            }
        } else {
            html = '<p class="text-muted">No related posts found. Try different keywords.</p>';
        }
        
        suggestionsDiv.innerHTML = html;
    })
    .catch(error => {
        suggestionsDiv.innerHTML = '<p class="text-danger">Error: ' + error + '</p>';
    });
}

// Create quick rule from suggestion
function createQuickRule(postTitle, postId) {
    const keyword = prompt(`Enter keyword to link to "${postTitle}":`);
    if (!keyword) return;
    
    fetch("{% url 'publisher:ajax_create_rule' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            keyword: keyword,
            target_post_id: postId,
            priority: 5
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Rule created: "${keyword}" ‚Üí "${postTitle}"`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error creating rule: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Network error: ' + error, 'danger');
    });
}

// Auto-save preferences
document.getElementById('preferencesForm').addEventListener('change', function() {
    const formData = new FormData(this);
    
    fetch("{% url 'publisher:manage_internal_links' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showAlert('Preferences saved automatically', 'info');
        }
    })
    .catch(error => {
        console.error('Error saving preferences:', error);
    });
});

// Search/filter rules
function filterRules() {
    const searchTerm = document.getElementById('ruleSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#rulesTable tbody tr');
    
    rows.forEach(row => {
        const keyword = row.querySelector('td:first-child').textContent.toLowerCase();
        const post = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        
        if (keyword.includes(searchTerm) || post.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Bulk operations
function selectAllRules(checkbox) {
    const checkboxes = document.querySelectorAll('.rule-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function bulkDeleteRules() {
    const selected = document.querySelectorAll('.rule-checkbox:checked');
    if (selected.length === 0) {
        showAlert('No rules selected', 'warning');
        return;
    }
    
    if (!confirm(`Delete ${selected.length} rules?`)) return;
    
    const ruleIds = Array.from(selected).map(cb => cb.value);
    
    Promise.all(ruleIds.map(id => 
        fetch(`/internal-links/rule/${id}/delete/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken}
        })
    ))
    .then(() => {
        showAlert(`Deleted ${ruleIds.length} rules`, 'success');
        setTimeout(() => location.reload(), 1000);
    })
    .catch(error => {
        showAlert('Error during bulk delete: ' + error, 'danger');
    });
}

// Initialize tooltips and popovers
document.addEventListener('DOMContentLoaded', function() {
    // Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add search box to rules table
    const searchBox = `
        <div class="mb-3">
            <input type="text" class="form-control" id="ruleSearch" 
                   placeholder="Search rules..." onkeyup="filterRules()">
        </div>
    `;
    document.querySelector('.card-body .table-responsive').insertAdjacentHTML('beforebegin', searchBox);
});

// Export rules to JSON
function exportRules() {
    fetch("{% url 'publisher:export_settings' %}")
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'linking_rules.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showAlert('Rules exported successfully', 'success');
        })
        .catch(error => {
            showAlert('Export failed: ' + error, 'danger');
        });
}
</script>
{% endblock %}
{%endblock%}
